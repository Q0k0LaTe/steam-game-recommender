<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Recommender</title>
    <!-- Steam uses Roboto for UI text -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', Arial, sans-serif;
            background-color: #171a21;
            color: #c7d5e0;
            min-height: 100vh;
            font-size: 13px;
        }
        /* Header bar */
        .steam-header {
            background-color: #171a21;
            border-bottom: 1px solid #000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .steam-nav {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 10px 20px;
        }
        .steam-logo {
            color: #66c0f4;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(102,192,244,0.5);
        }
        .steam-nav-item {
            margin-left: 20px;
            color: #c7d5e0;
            font-size: 13px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .steam-nav-item:hover { color: #66c0f4; }
        /* Container */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        /* Page header */
        .page-header {
            background-color: #1b2838;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            border: 1px solid #000;
        }
        .page-header h1 {
            font-size: 28px;
            color: #c7d5e0;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .page-header p {
            font-size: 14px;
            color: #8f98a0;
            line-height: 1.4;
        }
        /* Sections */
        .steam-section {
            background-color: #1b2838;
            border: 1px solid #000;
            border-radius: 4px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .section-header {
            background-color: #171a21;
            padding: 10px 15px;
            border-bottom: 1px solid #000;
            font-size: 14px;
            font-weight: 500;
            color: #66c0f4;
            text-transform: uppercase;
        }
        .section-content {
            padding: 15px;
        }
        /* Inputs & Buttons */
        .steam-input-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .steam-input {
            flex: 1;
            background-color: #2a475e;
            border: 1px solid #000;
            border-radius: 2px;
            padding: 10px;
            color: #c7d5e0;
            font-size: 14px;
        }
        .steam-input:focus {
            outline: none;
            border-color: #66c0f4;
            box-shadow: 0 0 5px rgba(102,192,244,0.3);
            background-color: #1b2838;
        }
        .steam-button {
            background-color: #66c0f4;
            border: 1px solid #66c0f4;
            color: #171a21;
            padding: 10px 20px;
            border-radius: 2px;
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .steam-button:hover { background-color: #4c94d8; }
        .steam-button:disabled {
            background-color: #67707b;
            border-color: #67707b;
            color: #8f98a0;
            cursor: not-allowed;
        }
        .steam-button.secondary {
            background-color: #2a475e;
            border-color: #2a475e;
            color: #c7d5e0;
        }
        .steam-button.secondary:hover {
            background-color: #1b2838;
        }
        .input-help {
            font-size: 11px;
            color: #8f98a0;
            margin-top: 5px;
        }
        /* Messages */
        .error-message, .success-message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }
        .error-message { background-color: #8b0000; color: #fff; border: 1px solid #000; }
        .success-message { background-color: #4c6b22; color: #fff; border: 1px solid #000; }
        /* Loading spinner */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .steam-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #2a475e;
            border-top: 3px solid #66c0f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Results */
        .results-section { display: none; }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #1b2838;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #000;
            margin-bottom: 20px;
        }
        .user-avatar {
            width: 64px;
            height: 64px;
            border-radius: 4px;
            border: 1px solid #000;
            background-color: #2a475e;
        }
        .user-info h3 {
            color: #66c0f4;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .user-stats { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 5px; }
        .stat-item {
            background-color: rgba(0,0,0,0.3);
            padding: 5px 8px;
            border-radius: 2px;
            font-size: 12px;
            color: #8f98a0;
            border: 1px solid rgba(0,0,0,0.5);
        }
        /* Games grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .game-capsule {
            background-color: #1b2838;
            border: 1px solid #000;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .game-capsule:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .game-header {
            height: 100px;
            background-color: #2a475e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255,255,255,0.8);
            position: relative;
        }
        .game-info { padding: 12px; }
        .game-title { font-size: 14px; font-weight: 500; color: #c7d5e0; margin-bottom: 6px; }
        .game-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .game-tag {
            background-color: rgba(102,192,244,0.2);
            color: #66c0f4;
            padding: 2px 6px;
            border-radius: 2px;
            font-size: 10px;
            border: 1px solid rgba(102,192,244,0.3);
        }
        .game-footer { display: flex; justify-content: space-between; align-items: center; }
        .match-score { font-size: 11px; font-weight: 500; color: #66c0f4; }
        .game-price { font-size: 14px; font-weight: 700; color: #99bc0f; }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #171a21; }
        ::-webkit-scrollbar-thumb { background: rgba(102,192,244,0.3); border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(102,192,244,0.5); }
        @media (max-width: 768px) {
            .steam-input-group { flex-direction: column; }
            .user-profile { flex-direction: column; text-align: center; }
            .games-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="steam-header">
        <div class="steam-nav">
            <div class="steam-logo">Game Recommender</div>
            <div class="steam-nav-item">STORE</div>
            <div class="steam-nav-item">COMMUNITY</div>
            <div class="steam-nav-item">ABOUT</div>
        </div>
    </div>
    <div class="container">
        <div class="page-header">
            <h1>Game Recommender</h1>
            <p>Get personalized game recommendations based on your Steam profile and play history.</p>
        </div>
        <div class="steam-section">
            <div class="section-header">Enter Steam Profile</div>
            <div class="section-content">
                <div class="steam-input-group">
                    <input type="text" class="steam-input" id="steamId" placeholder="Steam ID, Profile URL, or Custom URL">
                    <button class="steam-button" id="getRecommendationsBtn" onclick="getRecommendations()">Get Recommendations</button>
                    <button class="steam-button secondary" onclick="clearResults()">Clear</button>
                </div>
                <div class="input-help">Examples: 76561198037867621, steamcommunity.com/id/username</div>
            </div>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        <div class="loading" id="loading">
            <div class="steam-spinner"></div>
            <p>Fetching profile and analyzing games...</p>
        </div>
        <div class="results-section" id="results">
            <div class="user-profile" id="userProfile">
                <img class="user-avatar" id="userAvatar" src="" alt="Avatar">
                <div class="user-info">
                    <h3 id="userName">Steam User</h3>
                    <div class="user-stats">
                        <div class="stat-item">Games: <span id="gamesOwned">0</span></div>
                        <div class="stat-item">Hours: <span id="hoursPlayed">0</span></div>
                        <div class="stat-item">Level: <span id="userLevel">0</span></div>
                        <div class="stat-item">Since: <span id="memberSince">-</span></div>
                    </div>
                </div>
            </div>
            <div class="steam-section">
                <div class="section-header">Recommended For You</div>
                <div class="section-content">
                    <div class="games-grid" id="gamesGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSteamId = null;

        function showError(message, suggestions = []) {
            const errorEl = document.getElementById('errorMessage');
            let errorHTML = message;
            
            if (suggestions && suggestions.length > 0) {
                errorHTML += '<br><br><strong>Try these solutions:</strong><ul>';
                suggestions.forEach(suggestion => {
                    errorHTML += `<li>${suggestion}</li>`;
                });
                errorHTML += '</ul>';
            }
            
            errorEl.innerHTML = errorHTML;
            errorEl.style.display = 'block';
            hideSuccess();
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            hideError();
        }

        function hideSuccess() {
            document.getElementById('successMessage').style.display = 'none';
        }

        function setLoading(loading) {
            const loadingEl = document.getElementById('loading');
            const btn = document.getElementById('getRecommendationsBtn');
            
            if (loading) {
                loadingEl.style.display = 'block';
                btn.disabled = true;
                btn.textContent = 'Loading...';
            } else {
                loadingEl.style.display = 'none';
                btn.disabled = false;
                btn.textContent = 'Get Recommendations';
            }
        }

        async function getRecommendations() {
            const steamId = document.getElementById('steamId').value.trim();
            
            if (!steamId) {
                showError('Please enter a Steam ID, profile URL, or username');
                return;
            }

            hideError();
            hideSuccess();
            setLoading(true);
            document.getElementById('results').style.display = 'none';
            
            try {
                console.log(`Requesting recommendations for: ${steamId}`);
                
                // Fetch recommendations from backend with longer timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 second timeout
                
                const response = await fetch(`/api/recommendations/${encodeURIComponent(steamId)}`, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch recommendations');
                }
                
                currentSteamId = steamId;
                displayResults(data.profile, data.recommendations);
                showSuccess(`Successfully loaded profile for ${data.profile.personaName}`);
                
            } catch (error) {
                console.error('Error:', error);
                
                let errorMessage = error.message;
                let suggestions = [];
                
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out. Steam servers might be slow or unreachable.';
                    suggestions = [
                        'Steam Community might be experiencing issues',
                        'Try again in a few minutes',
                        'Check if Steam is down using a service like downdetector.com',
                        'Make sure your internet connection is stable'
                    ];
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'Cannot connect to the server.';
                    suggestions = [
                        'Check your internet connection',
                        'Make sure the server is running',
                        'Try refreshing the page'
                    ];
                } else {
                    // Try to parse suggestions from server response
                    try {
                        const response = await fetch(`/api/recommendations/${encodeURIComponent(steamId)}`);
                        const errorData = await response.json();
                        if (errorData.suggestions) {
                            suggestions = errorData.suggestions;
                        }
                    } catch (e) {
                        // Ignore parsing errors
                    }
                }
                
                showError(errorMessage, suggestions);
            } finally {
                setLoading(false);
            }
        }

        function displayResults(profile, recommendations) {
            // Update user profile
            document.getElementById('userName').textContent = profile.personaName || 'Unknown Player';
            document.getElementById('gamesOwned').textContent = profile.games?.total || 0;
            document.getElementById('hoursPlayed').textContent = profile.games?.totalHours?.toLocaleString() || '0';
            document.getElementById('userLevel').textContent = profile.level || 0;
            document.getElementById('memberSince').textContent = profile.memberSince || '-';
            
            // Update avatar
            const avatarEl = document.getElementById('userAvatar');
            if (profile.avatarUrl) {
                avatarEl.src = profile.avatarUrl;
                avatarEl.style.display = 'block';
            } else {
                avatarEl.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMmE0NzVlIi8+Cjx0ZXh0IHg9IjMyIiB5PSI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI0IiBmaWxsPSIjNjZjMGY0IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj7wn5GEJJ48L3RleHQ+Cjwvc3ZnPg==';
            }
            
            // Update additional profile info
            document.getElementById('realName').textContent = profile.realName || '';
            document.getElementById('location').textContent = profile.location || '';
            
            // Update recent games
            if (profile.games?.recentGames && profile.games.recentGames.length > 0) {
                const recentGamesEl = document.getElementById('recentGamesList');
                const recentGamesSection = document.getElementById('recentGamesSection');
                
                recentGamesEl.innerHTML = profile.games.recentGames.map(game => `
                    <div class="recent-game">
                        ${game.name}
                        <span class="hours">${game.hoursPlayed.toFixed(1)}h</span>
                    </div>
                `).join('');
                
                recentGamesSection.style.display = 'block';
            }
            
            // Display game recommendations
            const gamesGrid = document.getElementById('gamesGrid');
            gamesGrid.innerHTML = recommendations.map(game => `
                <div class="game-capsule" onclick="openSteamStore('${game.appId}', '${game.title}')">
                    <div class="game-header" style="background: ${game.gradient}">
                        ${game.icon}
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                        <div class="game-tags">
                            ${game.tags.map(tag => `<span class="game-tag">${tag}</span>`).join('')}
                        </div>
                        <div class="game-footer">
                            <div class="match-score">${game.matchPercentage}% Match</div>
                            <div class="game-price">${game.price}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('results').style.display = 'block';
        }

        function openSteamStore(appId, title) {
            // Try to open in Steam client first, fallback to web
            const steamUrl = `steam://store/${appId}`;
            const webUrl = `https://store.steampowered.com/app/${appId}`;
            
            // Create temporary link to attempt Steam protocol
            const link = document.createElement('a');
            link.href = steamUrl;
            link.click();
            
            // Fallback to web after short delay
            setTimeout(() => {
                window.open(webUrl, '_blank');
            }, 1000);
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('steamId').value = '';
            hideError();
            hideSuccess();
            currentSteamId = null;
        }

        // Enter key support
        document.getElementById('steamId').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getRecommendations();
            }
        });

        // Auto-focus input
        document.getElementById('steamId').focus();
    </script>
</body>
</html>